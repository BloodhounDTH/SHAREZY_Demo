// ===== Sharezy Signature (contract) =====
// - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡πÉ‡∏ä‡πâ window.DB_USERS ‡πÅ‡∏ó‡∏ô DB.users
// - ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÉ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á(‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤+‡∏ä‡∏∑‡πà‡∏≠+‡∏™‡∏Å‡∏∏‡∏•), ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô, ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô, ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡∏≠‡∏µ‡πÄ‡∏°‡∏•)
// - ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¥‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (DB.orders, products, computeSettlement, money, fmtDateLabelTH, ‡∏Ø‡∏•‡∏Ø)

/**
 * ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á Modal
 * @param {object} order - ‡∏≠‡πá‡∏≠‡∏ö‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏à‡∏≤‡∏Å DB.orders
 * @param {object} currentUser - ‡∏≠‡πá‡∏≠‡∏ö‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏≤‡∏Å state.user
 */

function maskNationalId(id) {
  if (!id) return 'N/A';
  // ‡∏Ñ‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô ‡πÄ‡∏ä‡πà‡∏ô X-XXXX-XXXXX-XX-X
  const digits = id.replace(/\D/g,'');
  if (digits.length < 13) return '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô';
  return id.replace(/\d/g, '‚Ä¢'); // ‡πÄ‡∏ö‡∏•‡∏≠‡∏ó‡∏∏‡∏Å‡∏´‡∏•‡∏±‡∏Å
}

function showSignaturePage(order, currentUser) {
  if (!order || !currentUser) {
    console.error("showSignaturePage: Order or currentUser is missing.");
    showToast?.('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÑ‡∏î‡πâ', 'error');
    return;
  }

  // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏ã‡πâ‡∏≠‡∏ô
  if (document.getElementById('signature-modal-overlay')) return;

  // --- 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏Ç‡∏≠‡∏á Modal ---
  const modalOverlay = document.createElement('div');
  modalOverlay.id = 'signature-modal-overlay';
  modalOverlay.className = 'modal-backdrop show'; 
  
  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≤‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
  const st = computeSettlement(order); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  const _users = (window.DB_USERS || []);
  const owner  = _users.find(u => u.id === order.ownerId)  || {};
  const renter = _users.find(u => u.id === order.renterId) || {};

  const rentalEndDate = parseDateInput(order.rentalEnd);
  const returnDate = rentalEndDate ? addDays(rentalEndDate, 1) : null;

  const itemsHtml = order.items.map(id => {
    const p = products.find(x => x.id === id) || {};
    const details = [
      p.category && `<li><strong>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</strong> ${p.category}</li>`,
      p.color && `<li><strong>‡∏™‡∏µ:</strong> ${p.color}</li>`,
      p.size && `<li><strong>‡∏Ç‡∏ô‡∏≤‡∏î:</strong> ${p.size}</li>`
    ].filter(Boolean).join('');
    return `
      <div class="contract-item">
        <p><strong>- ${p.title || 'Unknown Item'}</strong> (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: 1)</p>
        ${details ? `<ul class="item-details">${details}</ul>` : ''}
      </div>
    `;
  }).join('');

  const isRenter = currentUser.id === order.renterId;
  const isOwner  = currentUser.id === order.ownerId;
  const isAdmin = currentUser?.role === 'admin';

  // helper: ‡∏ó‡∏≥‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤
  const fullName = (u) => [u.title||'', u.firstName||'', u.lastName||'']
  .join(' ').replace(/\s+/g,' ').trim();

  // ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤ & ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤ (‡∏£‡∏ß‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á/‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô/‡∏ö‡∏±‡∏ï‡∏£/‡∏≠‡∏µ‡πÄ‡∏°‡∏•)
    const partyBlock = (label, u) => {
    const natIdText = (canSeeNatId && canSeeNatId(currentUser, u)) ? (u.nationalId || 'N/A') : (maskNationalId ? maskNationalId(u.nationalId) : 'N/A');
    return `
        <p class="ml-4"><strong>${label}:</strong> ${fullName(u) || 'N/A'}</p>
        <ul class="ml-8">
        <li><strong>‡∏ä‡∏∑‡πà‡∏≠ user (‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ö‡∏ô‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°):</strong> ${u.name || 'N/A'}</li>
        <li data-sensitive="nationalId"><strong>‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</strong> ${natIdText}</li>
        <li><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${u.address || 'N/A'}</li>
        <li><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö SHAREZY:</strong> ${u.email || 'N/A'}</li>
        </ul>
    `;
    };

  modalOverlay.innerHTML = `
    <div class="modal order-detail-modal signature-modal-size contract-printable-container" style="display: flex; flex-direction: column;" role="dialog" aria-modal="true">
      <button class="modal-close" data-close="1">√ó</button>

      <div class="my-info-header">
        <strong>‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå</strong>
        <small class="muted">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: ${order.orderNo}</small>
      </div>

      <div class="my-info-body" style="line-height: 1.7;">
        <p class="mb-4"><strong>‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏â‡∏ö‡∏±‡∏ö‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á:</strong></p>
        ${partyBlock('‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤', owner)}
        ${partyBlock('‡πÅ‡∏•‡∏∞ ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤', renter)}
        <p class="mb-4">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: ${order.orderNo}</p>

        <h3 class="font-bold text-lg mb-2">‡∏Ç‡πâ‡∏≠ 1: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πà‡∏≤</h3>
        <p>‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏ï‡∏Å‡∏•‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏ï‡∏Å‡∏•‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏î‡∏±‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:</p>
        <ul class="my-3">${itemsHtml}</ul>
        
        <h3 class="font-bold text-lg mb-2 mt-6">‡∏Ç‡πâ‡∏≠ 2: ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤</h3>
        <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ä‡πà‡∏≤:</strong> ${fmtDateLabelTH(order.rentalStart)}</p>
        <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</strong> ${fmtDateLabelTH(order.rentalEnd)}</p>
        <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô:</strong> ${returnDate ? fmtDateLabelTH(returnDate) : 'N/A'}</p>
        <p>‡πÇ‡∏õ‡∏£‡∏î‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 18:00 ‡∏ô. ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô</p>
        <p> ** ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏à‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏•‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ** </p>

        <h3 class="font-bold text-lg mb-2 mt-6">‡∏Ç‡πâ‡∏≠ 3: ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</h3>
        <p><strong>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏ß‡∏°:</strong> ${money(st.rent)} ‡∏ö‡∏≤‡∏ó</p>
        <p><strong>‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥:</strong> ${money(st.deposit)} ‡∏ö‡∏≤‡∏ó</p>
        <p><strong>‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:</strong> ${money(st.shipOut)} ‡∏ö‡∏≤‡∏ó</p>
        <p class="font-bold"><strong>‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô:</strong> ${money(st.grand)} ‡∏ö‡∏≤‡∏ó</p>

        <h3 class="font-bold text-lg mb-2 mt-6">‡∏Ç‡πâ‡∏≠ 4: ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á</h3>
        <p>‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö <a href="/terms" target="_blank" class="text-blue-600 hover:underline">‡∏Å‡∏é‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á Sharezy</a> ‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£ ‡∏ã‡∏∂‡πà‡∏á‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ô‡∏µ‡πâ</p>

        <h3 class="font-bold text-lg mb-2 mt-6">‡∏Ç‡πâ‡∏≠ 5: ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ô‡∏≤‡∏°‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå (e-Signature)</h3>
        <p>‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÉ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤" ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏≤‡∏á‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏ú‡∏π‡∏Å‡∏û‡∏±‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢</p>
      </div>

      <!-- Footer & Signature Area -->
      <div class="my-info-footer" style="flex-direction: column; gap: 1rem;">
        <label class="accept-terms" style="align-self: flex-start;">
          <input type="checkbox" id="agreement-checkbox">
          <span>‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ô‡∏µ‡πâ‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£</span>
        </label>
        <div style="display: flex; width: 100%; gap: 10px;">
          <button id="print-contract-btn" class="btn w-full" style="background-color: #6c757d;">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤</button>
          <button id="sign-contract-btn" disabled class="btn-primary w-full">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÉ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤</button>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modalOverlay);

  // ‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤
  const printButton = document.getElementById('print-contract-btn');
  if (printButton) {
    printButton.addEventListener('click', () => {
      const contractContent = modalOverlay.querySelector('.my-info-body');
      if (!isAdmin) {
  modalOverlay.classList.add('blur-sensitive');
}
      if (contractContent) printElement(contractContent);
    });
  }

  // --- 2. Event Listeners ---
  const checkbox = document.getElementById('agreement-checkbox');
  const signButton = document.getElementById('sign-contract-btn');
  const closeModal = () => document.body.removeChild(modalOverlay);

  modalOverlay.addEventListener('click', e => {
    if (e.target.closest('[data-close]')) closeModal();
  });

  checkbox.addEventListener('change', () => {
    signButton.disabled = !checkbox.checked;
  });

  signButton.addEventListener('click', () => {
    if (!checkbox.checked) return;

    signButton.disabled = true;
    signButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...';

    let nextStatus = '';
    if (isRenter && order.status === 'awaiting_renter_signature') {
      nextStatus = 'awaiting_owner_signature';
    } else if (isOwner && order.status === 'awaiting_owner_signature') {
      nextStatus = 'placed';
    }

    if (nextStatus) {
      const success = updateOrderStatus(order.id, nextStatus);
      if (success) {
        showToast?.('‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÉ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        handlePostSignature(nextStatus, order);
      } else {
        showToast?.('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
        signButton.disabled = false;
        signButton.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÉ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤';
      }
    } else {
      showToast?.('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
    }
  });
}

/**
 * ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô DB object
 * @param {number} orderId - ID ‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
 * @param {string} newStatus - ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà
 * @returns {boolean} - ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ true ‡∏ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
 */
function updateOrderStatus(orderId, newStatus) {
  try {
    const orderIndex = DB.orders.findIndex(o => o.id === orderId);
    if (orderIndex === -1) {
      console.error(`Order with ID ${orderId} not found.`);
      return false;
    }
    DB.orders[orderIndex].status = newStatus;
    saveOrders?.(); // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    return true;
  } catch (error) {
    console.error('Error in updateOrderStatus:', error);
    return false;
  }
}

/**
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ UI ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á Notification ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏á‡∏ô‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
 * @param {string} newStatus - ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
 * @param {object} order - ‡∏≠‡πá‡∏≠‡∏ö‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
 */
function handlePostSignature(newStatus, order) {
  const modal = document.getElementById('signature-modal-overlay');
  if (modal) modal.remove();

  const orderLink = `#/order/${order.id}`;

  if (newStatus === 'awaiting_owner_signature') {
    // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à -> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
    pushNotif?.({ 
      text: `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÉ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ${order.orderNo} ‡πÅ‡∏•‡πâ‡∏ß`, 
      link: orderLink, 
      forRole: 'owner',  
      toId: order.ownerId  
    });

    // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤
    pushNotif?.({
      text: `‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ${order.orderNo}: ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ`,
      link: orderLink,
      forRole: 'renter',
      toId: order.renterId
    });

    showInfoModal?.('‡∏•‡∏á‡∏ô‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå');
  
  } else if (newStatus === 'placed') {
    // ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à -> ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå -> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    pushNotif?.({ 
      text: `‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ${order.orderNo} ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå! ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏à‡∏±‡∏î‡∏™‡πà‡∏á`, 
      link: orderLink, 
      forRole: 'renter', 
      toId: order.renterId 
    });
    
    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á
    const updatedOrder = DB.orders.find(o => o.id === order.id);
    if (updatedOrder) {
      openOwnerOrderDetail?.(updatedOrder);
    }
  }
}
